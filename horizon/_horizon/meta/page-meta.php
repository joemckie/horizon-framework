<?php

/*
*
*	@version: 1.0.0
*	@author: Joe McKie
*	@link: http://joemck.ie/
*	@copyright: Joe McKie 2013
*
*	This file is part of the Horizon Framework.
*
*   Horizon Framework is free software: you can redistribute it and/or modify
*   it under the terms of the GNU General Public License as published by
*   the Free Software Foundation, either version 3 of the License, or
*   (at your option) any later version.
*
*   Horizon Framework is distributed in the hope that it will be useful,
*   but WITHOUT ANY WARRANTY; without even the implied warranty of
*   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
*   GNU General Public License for more details.
*
*   You should have received a copy of the GNU General Public License
*   along with the Horizon Framework.  If not, see <http://www.gnu.org/licenses/>.
*
*	Horizon Framework is built and maintained by Joe McKie (http://joemck.ie/)
*
*/

$element_sizes = array(
	"Accordion" => array(
		"size1-4" => "1/4",
		"size1-3" => "1/3",
		"size1-2" => "1/2",
		"size2-3" => "2/3",
		"size3-4" => "3/4",
		"size1-1" => "1/1",
		"default" => "size1-4"
	),
	"Blog" => array(
		"size1-4" => "1/4",
		"size1-3" => "1/3",
		"size1-2" => "1/2",
		"size2-3" => "2/3",
		"size3-4" => "3/4",
		"size1-1" => "1/1",
		"default" => "size1-1"
	),
	"Call-To-Action" => array(
		"size1-4" => "1/4",
		"size1-3" => "1/3",
		"size1-2" => "1/2",
		"size2-3" => "2/3",
		"size3-4" => "3/4",
		"size1-1" => "1/1",
		"default" => "size1-1"
	),
	"Column" => array(
		"size1-4" => "1/4",
		"size1-3" => "1/3",
		"size1-2" => "1/2",
		"size2-3" => "2/3",
		"size3-4" => "3/4",
		"size1-1" => "1/1",
		"default" => "size1-3"
	),
	"Column-Service" => array(
		"size1-4" => "1/4",
		"size1-3" => "1/3",
		"size1-2" => "1/2",
		"size2-3" => "2/3",
		"size3-4" => "3/4",
		"size1-1" => "1/1",
		"default" => "size1-3"
	),
	"Contact-Form" => array(
		"size1-1" => "1/1",
		"default" => "size1-1"
	),
	"Content" => array(
		"size1-4" => "1/4",
		"size1-3" => "1/3",
		"size1-2" => "1/2",
		"size2-3" => "2/3",
		"size3-4" => "3/4",
		"size1-1" => "1/1",
		"default" => "size1-1"
	),
	"Divider" => array(
		"size1-1" => "1/1",
		"default" => "size1-1"
	),
	"Full-Width-Banner" => array(
		"size1-1" => "1/1",
		"default" => "size1-1"
	),
	"Gallery" => array(
		"size1-4" => "1/4",
		"size1-3" => "1/3",
		"size1-2" => "1/2",
		"size2-3" => "2/3",
		"size3-4" => "3/4",
		"size1-1" => "1/1",
		"default" => "size1-1"
	),
	"Message-Box" => array(
		"size1-4" => "1/4",
		"size1-3" => "1/3",
		"size1-2" => "1/2",
		"size2-3" => "2/3",
		"size3-4" => "3/4",
		"size1-1" => "1/1",
		"default" => "size1-1"
	),
	"Price-Table" => array(
		"size1-4" => "1/4",
		"size1-3" => "1/3",
		"size1-2" => "1/2",
		"size2-3" => "2/3",
		"size3-4" => "3/4",
		"size1-1" => "1/1",
		"default" => "size1-1"
	),
	"Portfolio" => array(
		"size1-4" => "1/4",
		"size1-3" => "1/3",
		"size1-2" => "1/2",
		"size2-3" => "2/3",
		"size3-4" => "3/4",
		"size1-1" => "1/1",
		"default" => "size1-1"
	),
	"Post-Slider" => array(
		"size1-1" => "1/1",
		"default" => "size1-1"
	),
	"Section-Start" => array(
		"size1-1" => "1/1",
		"default" => "size1-1"
	),
	"Section-End" => array(
		"size1-1" => "1/1",
		"default" => "size1-1"
	),
	"Sidebar" => array(
		"size1-4" => "1/4",
		"size1-3" => "1/3",
		"size1-2" => "1/2",
		"size2-3" => "2/3",
		"size3-4" => "3/4",
		"size1-1" => "1/1",
		"default" => "size1-3"
	),
	"Staff" => array(
		"size1-4" => "1/4",
		"size1-3" => "1/3",
		"size1-2" => "1/2",
		"size2-3" => "2/3",
		"size3-4" => "3/4",
		"size1-1" => "1/1",
		"default" => "size1-1"
	),
	"Tabs" => array(
		"size1-4" => "1/4",
		"size1-3" => "1/3",
		"size1-2" => "1/2",
		"size2-3" => "2/3",
		"size3-4" => "3/4",
		"size1-1" => "1/1",
		"default" => "size1-3"
	),
	"Testimonial" => array(
		"size1-4" => "1/4",
		"size1-3" => "1/3",
		"size1-2" => "1/2",
		"size2-3" => "2/3",
		"size3-4" => "3/4",
		"size1-1" => "1/1",
		"default" => "size1-3"
	),
	"Toggle" => array(
		"size1-4" => "1/4",
		"size1-3" => "1/3",
		"size1-2" => "1/2",
		"size2-3" => "2/3",
		"size3-4" => "3/4",
		"size1-1" => "1/1",
		"default" => "size1-3"
	),
);

// Add page options with the add_meta_boxes hook
add_action( 'add_meta_boxes', 'horizon_add_page_options' );
function horizon_add_page_options() {
	add_meta_box( 'custom_meta_boxes', __( 'Page Options' ), 'horizon_build_page_options', 'page', 'normal', 'high' );
}

// Let's build the custom page options!
function horizon_build_page_options() {
	// Get the post details and also all of our custom boxes we'll need
	global $post, $page_tabs, $page_meta_boxes, $element_sizes;

	$html = "";
	$html .= "<div class='horizon_over_wrap'>";
	$html .= "<div class='horizon_over_content'>";
	$html .= '<div class="overlay"></div>';
	$html .= '<div class="meta_box_tabs">';
	$html .= '<ul>';
	$i = 0;
	foreach ( $page_tabs as $tab_name => $tab_id ) {
		$status = $i == 0 ? 'active' : '';
		$html .= '<li class="' . $status . '" rel="' . $tab_id . '">' . $tab_name . '</li>';
		$i++;
	}
	$html .= '</ul>';
	$html .= '</div>';

	$page_meta_boxes_gallery = isset( $page_meta_boxes['page-builder']['Page Builder']['elements']['Gallery'] ) ? $page_meta_boxes['page-builder']['Page Builder']['elements']['Gallery'] : NULL;
	if ( $page_meta_boxes_gallery !== NULL ) {
		$page_meta_boxes_gallery['gallery_name']['options'] = horizon_get_post_list( 'gallery' );
	}

	$page_meta_boxes_price_tables = isset( $page_meta_boxes['page-builder']['Page Builder']['elements']['Price-Table'] ) ? $page_meta_boxes['page-builder']['Page Builder']['elements']['Price-Table'] : NULL;
	if ( $page_meta_boxes_price_tables !== NULL ) {
		$page_meta_boxes_price_tables['category']['options'] = horizon_get_taxonomy_list( 'price-table-category' );
	}

	if ( $page_meta_boxes['page-builder']['Page Builder']['elements']['Testimonial'] !== NULL ) {
		$page_meta_boxes['page-builder']['Page Builder']['elements']['Testimonial']['category']['options'] = horizon_get_taxonomy_list( 'testimonial-category' );
	}

	if ( $page_meta_boxes['page-builder']['Page Builder']['elements']['Blog'] !== NULL ) {
		$page_meta_boxes['page-builder']['Page Builder']['elements']['Blog']['category']['options'] = horizon_get_taxonomy_list( 'category' );
	}

	if ( $page_meta_boxes['page-builder']['Page Builder']['elements']['Portfolio'] !== NULL ) {
		$page_meta_boxes['page-builder']['Page Builder']['elements']['Portfolio']['category']['options'] = horizon_get_taxonomy_list( 'portfolio-category' );
	}

	if ( $page_meta_boxes['page-builder']['Page Builder']['elements']['Post-Slider'] !== NULL ) {
		$page_meta_boxes['page-builder']['Page Builder']['elements']['Post-Slider']['category']['options'] = horizon_get_taxonomy_list( 'category' );
	}

	// Loop through custom options to display them
	$i = 0;
	foreach ( $page_meta_boxes as $tab => $elements ):
		$status = $tab == "page-builder" ? 'active' : '';
		$html .= '<div id="' . $tab . '" class="meta_panel ' . $status . '">';
		foreach ( $elements as $meta_box ):
			if ( $meta_box['type'] == "page-builder-element" ) {
				$meta_box['value'] = get_post_meta( $post->ID, $meta_box['name'], true );

				$html .= horizon_build_element_templates( $meta_box );
				$html .= horizon_build_default_pagebuilder( $meta_box );
			} else {
				// Init the meta box name
				$meta_box['name'] = isset( $meta_box['name'] ) ? $meta_box['name'] : '';
				$meta_box['value'] = get_post_meta( $post->ID, $meta_box['name'], true );

				$html .= horizon_sort_meta_boxes( $meta_box );

				if ( empty( $meta_box['no_hr'] ) ) {
					if ( $meta_box['type'] != 'open' && $meta_box['type'] != 'close' ) {
						$html .= '<hr class="separator mt20">';
					}
				}
			}
		endforeach;
		$html .= '</div>';
		$i++;
	endforeach;
	$html .= "</div>";
	$html .= "</div>";

	echo $html;
}

function horizon_build_default_pagebuilder( $meta_box ) {
	$html = '';
	$html .= '<div id="page_builder_wrap">';
	$html .= '<div class="add_element">';
	$html .= '<select id="page_builder_element" class="pretty-select" name="page_builder_element">';
	foreach ( $meta_box['elements'] as $element => $args ) {
		$html .= '<option value="' . $element . '">' . $element . '</option>';
	}
	$html .= '</select>';
	$html .= '<button class="button red" id="add_element" type="button">Add Element</button>';
	$html .= '</div>';
	$html .= '<div id="page_builder">';
	$html .= '<div id="page_builder_elements">';
	if ( $meta_box['value'] !== "" ) {
		$html .= horizon_build_saved_pagebuilder( $meta_box['value'] );
	}
	$html .= '</div>';
	$html .= '<div class="clear"></div>';
	$html .= '</div>';
	$html .= '</div>';

	return $html;
}

function horizon_build_element_templates( $meta_box ) {
	global $element_sizes;

	$html = '';
	$html .= '<div id="page_builder_templates">';
	foreach ( $meta_box['elements'] as $element => $sub_elements ) {
		$html .= '<div class="column ' . $element_sizes[$element]['default'] . '" rel="' . $element . '">';
		$html .= '<div class="page-builder-element">';
		$html .= '<div class="size-changer"><span class="larger"></span><span class="smaller"></span></div><span class="type">' . $element . '</span><div class="edit"><span class="element_edit"></span><span class="element_delete"></span></div><input type="hidden" id="page-builder-size" value="' . $element_sizes[$element]['default'] . '" /><input type="hidden" id="page-builder-type" value="' . $element . '" />';
		$html .= '</div>';
		$html .= '<div class="page-builder-options">';
		foreach ( $sub_elements as $sub_element => $args ) {
			$args['pretty_select'] = false;
			if ( $sub_element == "acc_item" || $sub_element == "toggle_item" || $sub_element == "tab_item" ) {
				$html .= '<div class="add_sub_item">';
				$html .= '<div class="meta_box">';
				$html .= '<div class="meta_title"><a class="button add-sub-item">ADD ITEM</a></div>';
				$html .= '</div>';
				$html .= '</div>';
				$html .= '<ul class="tab_list">';
				$html .= '<input type="hidden" class="' . $args['sub_item_count']['name'] . '" id="tab-number" name="" value="0" />';
				$html .= '<li class="template">';
				$html .= '<a class="delete-sub-item"></a>';
				foreach ( $args as $li_item ) {
					if ( $li_item['type'] !== 'count' ) {
						$html .= horizon_sort_meta_boxes( $li_item, 'sub_item' );
					}
				}
				$html .= '</li>';
				$html .= '</ul>';
				$html .= '<div class="clear"></div>';
			} else {
				$html .= horizon_sort_meta_boxes( $args );
			}
			if ( !isset( $args['no_hr'] ) ) {
				if ( !isset( $args['type'] ) || ( $args['type'] != 'open' && $args['type'] != 'close' ) ) {
					$html .= '<hr class="separator mt20">';
				}
			}
		}
		$html .= '</div>';
		$html .= '</div>';
	}
	$html .= '</div>';
	$html .= '<div id="page_content_editor"><div class="editor_header">Element Editor<span class="editor_close">X</span></div><div class="editor_content"></div><div class="editor_footer"><span class="editor_save button">Save</span></div></div>';

	return $html;
}

function horizon_build_saved_pagebuilder( $xml_string ) {
	$xml = new SimpleXMLElement( $xml_string );

	return horizon_page_builder_output( $xml, 'back-end' );
}

function horizon_save_page_options( $id ) {
	global $page_meta_boxes;
	$tabs = $page_meta_boxes;

	foreach ( $tabs as $meta_boxes ):
		foreach ( $meta_boxes as $meta_box ):

			// Save page builder
			if ( $meta_box['type'] == "page-builder-element" ) {
			
				$page_builder_size = isset($_POST[$meta_box['size']]) ? $_POST[$meta_box['size']] : NULL;
				
				$num = sizeof( $page_builder_size );

				$sub_item_num = array();
				$page_builder_xml = '<page_layout>';

				for ( $i = 0; $i < $num; $i++ ) {

					$element_type = $_POST[$meta_box['element']][$i];
					$page_builder_xml .= '<' . $element_type . '>';
					$element_size = $_POST[$meta_box['size']][$i];
					$page_builder_xml .= horizon_xml_tag( 'size', horizon_format_width( $element_size ) );

					if ( !isset( $sub_item_num[$element_type] ) ) {
						$sub_item_num[$element_type] = 0;
						if ( $element_type == 'Accordion' ) {
							$sub_item_type = "acc_item";
							$sub_item_num[$sub_item_type] = 0;
						} else if ( $element_type == 'Tabs' ) {
							$sub_item_type = "tab_item";
							$sub_item_num[$sub_item_type] = 0;
						} else if ( $element_type == 'Toggle' ) {
							$sub_item_type = "toggle_item";
							$sub_item_num[$sub_item_type] = 0;
						} else {
							$sub_item_type = '';
						}
					}
					
					// Sub item sorting
					if ( $element_type == 'Accordion' || $element_type == 'Tabs' || $element_type == 'Toggle' ) {
					
						$_POST[$meta_box['elements'][$element_type][$sub_item_type]['sub_item_count']['name']][$sub_item_num[$element_type]]
						= isset($_POST[$meta_box['elements'][$element_type][$sub_item_type]['sub_item_count']['name']][$sub_item_num[$element_type]])
						? $_POST[$meta_box['elements'][$element_type][$sub_item_type]['sub_item_count']['name']][$sub_item_num[$element_type]]
						: NULL;

						$sub_item_count 
						=	!is_null($_POST[$meta_box['elements'][$element_type][$sub_item_type]['sub_item_count']['name']][$sub_item_num[$element_type]]) 
						? $_POST[$meta_box['elements'][$element_type][$sub_item_type]['sub_item_count']['name']][$sub_item_num[$element_type]] 
						: 0;

						for ( $s = 0; $s < $sub_item_count; $s++ ) {
							$page_builder_xml .= '<' . $sub_item_type . '>';
							foreach ( $meta_box['elements'][$element_type][$sub_item_type] as $sub_item => $sub_item_elements ) {
								$sub_item_elements['cdata'] = isset($sub_item_elements['cdata']) ? true : false;
								if ( $sub_item_elements['type'] != 'count' ) {
									if ( $sub_item_elements['type'] == "textarea" && $sub_item_elements['cdata'] ) {
										$content = apply_filters( 'horizon_encode_xml_string', $_POST[$sub_item_elements['name']][$sub_item_num[$sub_item_type]] );
										$page_builder_xml .= horizon_xml_tag( $sub_item, $content );
									} else {
										$page_builder_xml .= horizon_xml_tag( $sub_item, $_POST[$sub_item_elements['name']][$sub_item_num[$sub_item_type]] );
									}
								}
							}
							$page_builder_xml .= '</' . $sub_item_type . '>';
							$sub_item_num[$sub_item_type]++;
						}
					}
					
					// Save page builder meta
					foreach ( $meta_box['elements'][$element_type] as $tag_name => $args ) {
						$type = isset($args['type']) ? $args['type'] : NULL;
						if ( $type != "description" && $tag_name !== $sub_item_type && isset($args['name']) ) {
							$content = apply_filters( 'horizon_encode_xml_string', $_POST[$args['name']][$sub_item_num[$element_type]] );
							$page_builder_xml .= horizon_xml_tag( $tag_name, $content );
						}
					}
					$sub_item_num[$element_type]++;
					$page_builder_xml .= '</' . $element_type . '>';
				}
				$page_builder_xml .= '</page_layout>';

				if ( $page_builder_xml == "<page_layout></page_layout>" ) {
					$page_builder_xml = "";
				}

				$old_meta = get_post_meta( $id, $meta_box['name'], true );
				horizon_save_meta_data( $id, $page_builder_xml, $old_meta, $meta_box['name'] );

			// Ignore open and close divs
			} elseif ( $meta_box['type'] == "open" || $meta_box['type'] == "close" ) {
			
			} else {
				// Check if element is posted
				if ( isset( $_POST[$meta_box['name']] ) ) {
					if ( gettype( $_POST[$meta_box['name']] ) == "array" ) {
						foreach ( $_POST[$meta_box['name']] as $key ) {
							$arraystring .= $key . ', ';
						}
						$new_meta = stripslashes( $arraystring );
					} else {
						$new_meta = stripslashes( $_POST[$meta_box['name']] );
					}
				} else {
					if ( $meta_box['type'] == "checktoggle" ) {
						$new_meta = 'No';
					} else {
						$new_meta = '';
					}
				}
				$old_meta = get_post_meta( $id, $meta_box['name'], true );
				horizon_save_meta_data( $id, $new_meta, $old_meta, $meta_box['name'] );
			}
		endforeach;
	endforeach;
}